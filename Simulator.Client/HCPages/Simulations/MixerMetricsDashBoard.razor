@using MudBlazor
@using System.Linq
@using GeminiSimulator.Main
@using GeminiSimulator.PlantUnits.ManufacturingEquipments.Mixers

<MudContainer MaxWidth="MaxWidth.False" Class="pa-4">

    <MudPaper Class="pa-4 mb-4" Elevation="3">
        <div class="d-flex flex-wrap justify-space-between align-center gap-4">
            <div>
                <MudText Typo="Typo.h5"><b>🍩 Mixer Fleet Efficiency</b></MudText>
                <MudText Typo="Typo.caption">Real-time state distribution per equipment</MudText>
            </div>

            <div class="d-flex gap-3 align-center flex-wrap">
                <MudChip T="string" Size="Size.Small" Style="background-color:#4CAF50; color:white;">Production</MudChip>
                <MudChip T="string" Size="Size.Small" Style="background-color:#2196F3; color:white;">Washing</MudChip>
                <MudChip T="string" Size="Size.Small" Style="background-color:#FF9800; color:white;">Wait Tank</MudChip>
                <MudChip T="string" Size="Size.Small" Style="background-color:#F44336; color:white;">Starved/Error</MudChip>
            </div>
        </div>
    </MudPaper>

    <MudGrid>
        @foreach (var mixer in SortedMixers)
        {
            var stats = GetMixerStats(mixer);

            <MudItem xs="12" sm="6" md="4" lg="3">
                <MudCard Elevation="3" Class="h-100 d-flex flex-column">
                    <MudCardHeader>
                        <CardHeaderContent>
                            <div class="d-flex justify-space-between">
                                <MudText Typo="Typo.h6"><b>@mixer.Name</b></MudText>
                                <MudChip T="string" Color="@GetEfficiencyColor(stats.Efficiency)" Size="Size.Small" Variant="Variant.Filled">
                                    OEE: @stats.Efficiency.ToString("F0")%
                                </MudChip>
                            </div>
                            <MudText Typo="Typo.caption">Total: @FormatTime(stats.TotalTime)</MudText>
                        </CardHeaderContent>
                    </MudCardHeader>

                    <MudCardContent Class="d-flex flex-column align-center justify-center flex-grow-1">
                        @if (stats.TotalTime > 0)
                        {
                            <MudChart ChartType="ChartType.Donut"
                                      Width="120px"
                                      Height="120px"
                                      InputData="@stats.ChartData"
                                      InputLabels="@_chartLabels"
                                      ChartOptions="@_chartOptions" />
                        }
                        else
                        {
                            <MudAlert Severity="Severity.Info" Dense="true" Class="my-4">No Data</MudAlert>
                        }
                    </MudCardContent>

                    <MudCardActions Class="d-flex justify-space-around py-2" Style="background-color:var(--mud-palette-background-grey);">
                        <div class="d-flex flex-column align-center">
                            <MudIcon Icon="@Icons.Material.Filled.Bolt" Color="Color.Success" Size="Size.Small" />
                            <MudText Typo="Typo.caption"><b>@FormatTime(stats.ProdTime)</b></MudText>
                        </div>
                        <div class="d-flex flex-column align-center">
                            <MudIcon Icon="@Icons.Material.Filled.HourglassEmpty" Color="Color.Warning" Size="Size.Small" />
                            <MudText Typo="Typo.caption"><b>@FormatTime(stats.WaitTime)</b></MudText>
                        </div>
                        <div class="d-flex flex-column align-center">
                            <MudIcon Icon="@Icons.Material.Filled.ErrorOutline" Color="Color.Error" Size="Size.Small" />
                            <MudText Typo="Typo.caption"><b>@FormatTime(stats.StarvedTime)</b></MudText>
                        </div>
                    </MudCardActions>
                </MudCard>
            </MudItem>
        }
    </MudGrid>
</MudContainer>

@code {
    [Parameter] public SimulationEngine Engine { get; set; } = null!;

    private IEnumerable<BatchMixer> SortedMixers =>
        Engine?.Mixers.OrderBy(m => m.Name)
        ?? Enumerable.Empty<BatchMixer>();

    // CONFIGURACIÓN VISUAL
    // Etiquetas fijas para que el orden de colores siempre coincida
    private string[] _chartLabels = { "Production", "Washing", "Wait Tank", "Starved" };

    // Opciones con la paleta de colores FIJA
    // Index 0 (Prod) -> Verde
    // Index 1 (Wash) -> Azul
    // Index 2 (Wait) -> Naranja
    // Index 3 (Starved) -> Rojo
    private ChartOptions _chartOptions = new ChartOptions
    {
        ChartPalette = new[] { "#4CAF50", "#2196F3", "#FF9800", "#F44336" },
        ShowLegend = false,

    };

    // --- LÓGICA DE DATOS ---

    // Clase auxiliar para no recalcular todo en el HTML
    private record MixerStats(double TotalTime, double ProdTime, double WashTime, double WaitTime, double StarvedTime, double Efficiency, double[] ChartData);

    private MixerStats GetMixerStats(BatchMixer m)
    {
        // 1. Extraer Tiempos
        double prod = GetTime(m, MixerStateCategory.Batching) + GetTime(m, MixerStateCategory.Discharging);
        double wash = GetTime(m, MixerStateCategory.Washing);
        double wait = GetTime(m, MixerStateCategory.StarvedByTankBusy) + GetTime(m, MixerStateCategory.StarvedByTankHighLevel);
        double starved = GetTime(m, MixerStateCategory.StarvedByOperator) +
                         GetTime(m, MixerStateCategory.StarvedByFeederPump) +
                         GetTime(m, MixerStateCategory.StarvedByWashoutPump);

        double total = prod + wash + wait + starved; // Suma simplificada de lo que mostramos

        // 2. Calcular Eficiencia
        double eff = total > 0 ? (prod / total) * 100 : 0;

        // 3. Preparar Array para el Donut (IMPORTANTE: Mismo orden que _chartLabels y ChartPalette)
        // [0]Prod, [1]Wash, [2]Wait, [3]Starved
        double[] data = { prod, wash, wait, starved };

        return new MixerStats(total, prod, wash, wait, starved, eff, data);
    }

    private double GetTime(BatchMixer m, MixerStateCategory cat) =>
        m.StateAcumulator.ContainsKey(cat) ? m.StateAcumulator[cat] : 0;

    private string FormatTime(double seconds)
    {
        var ts = TimeSpan.FromSeconds(seconds);
        if (ts.TotalHours >= 1) return $"{ts.TotalHours:F1}h";
        return $"{ts.TotalMinutes:F0}m";
    }

    private Color GetEfficiencyColor(double eff) => eff switch
    {
        > 80 => Color.Success,
        > 50 => Color.Warning,
        _ => Color.Error
    };
}