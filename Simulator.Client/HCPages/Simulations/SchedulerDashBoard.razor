@using MudBlazor
@using GeminiSimulator.Main

<MudContainer MaxWidth="MaxWidth.False" Class="pa-4" Style="height: 100vh; overflow: hidden;">

    <MudPaper Class="pa-3 mb-3 d-flex justify-content-between align-center" Elevation="2">
        <div class="d-flex align-center gap-3">
            <MudIcon Icon="@Icons.Material.Filled.CompareArrows" Color="Color.Primary" Size="Size.Medium" />
            <div>
                <MudText Typo="Typo.h6"><b>MATCHMAKER: DEMAND vs SUPPLY</b></MudText>
                <MudText Typo="Typo.caption">Real-time scheduling logic</MudText>
            </div>
        </div>
    </MudPaper>

    <MudGrid Style="height: calc(100% - 50px);">

        <MudItem xs="12" md="7" Style="height: 100%;">
            <MudPaper Class="h-100 d-flex flex-column" Elevation="2">
                <div class="pa-2 border-b-2">
                    <MudText Typo="Typo.subtitle2" Color="Color.Success"><b>🧠 DECISION LOGIC</b></MudText>
                </div>
               
                <div class="flex-grow-1 overflow-auto">
                    <MudTable Items="@Scheduler?.DemandSnapshot" Dense="true" Hover="true" FixedHeader="true" Striped="true" Elevation="0">
                        <HeaderContent>
                            <MudTh>Tank</MudTh>
                            <MudTh>Line</MudTh>
                            <MudTh>Autonomy</MudTh>
                            <MudTh>Mass in Process</MudTh>
                            <MudTh>Mixer assigned</MudTh>
                        </HeaderContent>
                        <RowTemplate>
                            <MudTd>
                                <MudText Typo="Typo.body2" Style="font-weight:bold;">@context.TankName</MudText>
                                <MudText Typo="Typo.caption" Class="mud-text-secondary">@context.ProductName</MudText>
                            </MudTd>
                            <MudTd>
                                <MudText Typo="Typo.body2">
                                    <b>@context.Linename</b>
                                </MudText>
                            </MudTd>
                            <MudTd>
                                <MudText Typo="Typo.body2" Color="@(context.TimeToEmpty < 60 ? Color.Error : Color.Inherit)">
                                    <b>@context.TimeToEmpty.ToString("F0") min</b>
                                </MudText>
                            </MudTd>

                            <MudTd>
                                <MudText Typo="Typo.body2" Color="@(context.TimeToEmpty < 60 ? Color.Error : Color.Inherit)">
                                    <b>@context.TotalStorage</b>
                                </MudText>
                            </MudTd>

                            <MudTd>
                                @if (context.AssignedMixer != "--")
                                {
                                    <MudText Typo="Typo.body2" Color="Color.Info" Style="font-weight:bold;">@context.AssignedMixer</MudText>
                                }
                                else
                                {
                                    <MudText Typo="Typo.caption">-</MudText>
                                }
                            </MudTd>
                        </RowTemplate>
                    </MudTable>
                </div>
            </MudPaper>
        </MudItem>

        <MudItem xs="12" md="5" Style="height: 100%;">
            <MudPaper Class="h-100 d-flex flex-column" Elevation="2">
                <div class="pa-2 border-b-2">
                    <MudText Typo="Typo.subtitle2" Color="Color.Success"><b>🏭 MIXER FLEET</b></MudText>
                </div>
                <div class="flex-grow-1 overflow-auto">
                    <MudTable Items="@Scheduler?.SupplySnapshot" Dense="true" Hover="true" FixedHeader="true" Striped="true" Elevation="0">
                        <HeaderContent>
                            <MudTh>Mixer</MudTh>
                            <MudTh>Activity</MudTh>
                            <MudTh>ETA</MudTh>
                            <MudTh>Queue</MudTh>
                        </HeaderContent>
                        <RowTemplate>
                            <MudTd><b>@context.MixerName</b></MudTd>

                            <MudTd>
                                @if (context.Operation == "Off" || context.Operation == "Idle")
                                {
                                    <MudText Typo="Typo.caption" Class="mud-text-disabled">IDLE</MudText>
                                }
                                else
                                {
                                    <div class="d-flex flex-column">
                                        <MudText Typo="Typo.caption" Color="Color.Success">@context.Operation</MudText>
                                        <MudText Typo="Typo.caption" Style="font-weight:bold;">@context.CurrentProduct</MudText>
                                        <div class="d-flex align-center mt-1">
                                            <MudIcon Icon="@Icons.Material.Filled.ArrowForward" Size="Size.Small" style="font-size: 10px;" />
                                            <MudText Typo="Typo.caption" Color="Color.Info">To: @context.TargetTank</MudText>
                                        </div>
                                    </div>
                                }
                            </MudTd>

                            <MudTd>
                                @if (context.EtaMinutes > 0)
                                {
                                    <MudText Typo="Typo.body2">@context.EtaMinutes.ToString("F0") min</MudText>
                                    <MudProgressLinear Color="Color.Info" Value="@(100 - (context.EtaMinutes * 100 / 60))" Style="height:4px; width:40px;" />
                                }
                                else
                                {
                                    <MudIcon Icon="@Icons.Material.Filled.Check" Size="Size.Small" Color="Color.Success" />
                                }
                            </MudTd>

                            <MudTd>
                                @if (context.QueueList != null && context.QueueList.Count > 0)
                                {
                                    <MudTooltip Text="@(string.Join(", ", context.QueueList))">
                                        <MudBadge Content="@context.QueueList.Count" Color="Color.Primary" Overlap="true">
                                            <MudIcon Icon="@Icons.Material.Filled.Layers" />
                                        </MudBadge>
                                    </MudTooltip>
                                }
                            </MudTd>
                        </RowTemplate>
                    </MudTable>
                </div>
            </MudPaper>
        </MudItem>
    </MudGrid>
</MudContainer>

<style>
    .border-b-2 {
        border-bottom: 1px solid var(--mud-palette-divider);
    }
</style>

@code {
    // ESTE COMPONENTE AHORA ES PASIVO. Recibe datos y pinta.
    [Parameter] public SimulationEngine Engine { get; set; } = null!;
    [Parameter] public ProductionScheduler Scheduler { get; set; } = null!;
}