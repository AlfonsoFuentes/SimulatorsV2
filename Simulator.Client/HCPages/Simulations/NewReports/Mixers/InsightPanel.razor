@using MudBlazor
@using GeminiSimulator.NewFilesSimulations.ManufactureEquipments

<MudTabs Elevation="0" Rounded="false" PanelClass="pa-6" Style="border: 2px solid var(--mud-palette-lines-default); border-radius: 8px; height: 100%;">
    <MudTabPanel Text="PRODUCTION IMPACT">
        <MudGrid>
            <MudItem xs="12" md="7">
                <MudText Typo="Typo.h6" Style="font-weight: 900; text-transform: uppercase;">Projected Delay</MudText>
                <MudText Typo="Typo.h5" Style="@($"font-weight: 900; color: {(ChaosSeconds > 0 ? "var(--mud-palette-error)" : "var(--mud-palette-success)")};")">
                    @((ChaosSeconds / 60).ToString("F1")) MIN
                </MudText>
                <MudAlert Severity="@(ChaosSeconds > 0 ? Severity.Error : Severity.Success)" Variant="Variant.Filled" Class="mt-2">
                    @(ChaosSeconds > 0 ? $"Production is finishing {Math.Abs(ChaosSeconds / 60):F0} min later than planned." : "Production is exactly on schedule.")
                </MudAlert>
            </MudItem>
            <MudItem xs="12" md="5">
                <MudText Typo="Typo.h6" Style="font-weight: 900;">IDLE TIME</MudText>
                <MudText Typo="Typo.h5" Style="font-weight: 900; color: var(--mud-palette-info);">@TimeSpan.FromSeconds(IdleTime).ToString(@"hh\:mm\:ss")</MudText>
                <MudText Typo="Typo.body2" Style="font-weight: 700;">MACHINE READY BUT UNUSED</MudText>
            </MudItem>
        </MudGrid>
    </MudTabPanel>

    <MudTabPanel Text="EFFICIENCY KILLERS">
        <MudText Typo="Typo.h6" Class="mb-4" Style="font-weight: 900;">RESOURCE DELAY RANKING</MudText>
        <MudSimpleTable Elevation="0" Hover="true" Dense="true">
            <thead>
                <tr>
                    <th style="font-weight: 900;">MIXER | RESOURCE</th>
                    <th style="font-weight: 900; width: 35%;">GRAVITY</th>
                    <th style="font-weight: 900;" class="text-right">TIME LOST</th>
                </tr>
            </thead>
            <tbody>
                @{
                    var delayGroups = FilteredHistory
                        .Where(x => x.AccumulatedStarvation > 0)
                        .GroupBy(x => new { x.MixerName, x.ResourceName })
                        .Select(g => new { Mixer = g.Key.MixerName, Res = g.Key.ResourceName, Total = g.Sum(x => x.AccumulatedStarvation) })
                        .OrderByDescending(x => x.Total).ToList();

                    double maxDelay = delayGroups.FirstOrDefault()?.Total ?? 1;
                }
                @foreach (var item in delayGroups)
                {
                    <tr>
                        <td style="font-size: 0.8rem;">
                            <span style="font-weight: 900; color: var(--mud-palette-primary);">@item.Mixer.ToUpper()</span>
                            | @item.Res.ToUpper()
                        </td>
                        <td><MudProgressLinear Color="Color.Error" Value="@((item.Total / maxDelay) * 100)" Size="Size.Large" Rounded="true" /></td>
                        <td class="text-right" style="color: var(--mud-palette-error); font-weight: 900;">@item.Total.ToString("F0")s</td>
                    </tr>
                }
                @if (!delayGroups.Any())
                {
                    <tr><td colspan="3" class="text-center pa-4" style="color: var(--mud-palette-success); font-weight: 900;">NO STARVATION DETECTED.</td></tr>
                }
            </tbody>
        </MudSimpleTable>
    </MudTabPanel>
</MudTabs>

@code {
    [Parameter] public List<NewStepLink> FilteredHistory { get; set; } = new();
    [Parameter] public double ChaosSeconds { get; set; }
    [Parameter] public double IdleTime { get; set; }
}