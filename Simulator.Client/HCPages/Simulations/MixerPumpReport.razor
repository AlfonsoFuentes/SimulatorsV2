@using GeminiSimulator.NewFilesSimulations.Context
@using MudBlazor

<MudContainer MaxWidth="MaxWidth.ExtraLarge" Class="mt-6 mb-10">
    <MudPaper Elevation="0" Class="pa-4 mb-4 d-flex align-center mud-theme-primary-lighten-5 rounded-lg">
        <MudIcon Icon="@Icons.Material.Filled.Analytics" Size="Size.Large" Color="Color.Primary" Class="mr-4" />
        <div>
            <MudText Typo="Typo.h5" Style="font-weight: 700;">Plant Efficiency Dashboard</MudText>
            <MudText Typo="Typo.caption">Real-time analysis & Equipment filter</MudText>
        </div>
        <MudSpacer />

        <MudSelect T="string" Label="Select Equipment" Value="@_selectedMixer" ValueChanged="OnMixerChanged"
                   Variant="Variant.Outlined" Margin="Margin.Dense" Style="max-width: 250px; background: white;">
            <MudSelectItem Value="@("All")">All Mixers (Global)</MudSelectItem>
            @foreach (var m in Engine.Mixers)
            {
                <MudSelectItem Value="@m.Name">@m.Name</MudSelectItem>
            }
        </MudSelect>
    </MudPaper>

    <MudGrid Spacing="3">
        <MudItem xs="12" md="4">
            <MudStack Spacing="3">
                <MudCard Elevation="2" Class="mud-border-error border-l-4 border-solid">
                    <MudCardContent>
                        <MudText Typo="Typo.subtitle2" Class="mud-text-secondary">
                            @(_selectedMixer == "All" ? "Global Bottleneck" : $"Bottleneck for {_selectedMixer}")
                        </MudText>
                        <MudText Typo="Typo.h5" Color="Color.Error" Style="font-weight: 700;">
                            @GetCriticalPump()
                        </MudText>
                    </MudCardContent>
                </MudCard>

                <MudCard Elevation="2" Style="height: 320px;">
                    <MudCardHeader>
                        <CardHeaderContent><MudText Typo="Typo.h6">Downtime Reasons</MudText></CardHeaderContent>
                    </MudCardHeader>
                    <MudCardContent Class="d-flex justify-center">
                        @{
                            var reasons = GetFilteredReasons();
                        }
                        @if (reasons.Any(r => r.Value > 0))
                        {
                            <MudChart ChartType="ChartType.Donut"
                                      InputData="@reasons.Select(x => x.Value).ToArray()"
                                      InputLabels="@reasons.Select(x => x.Key).ToArray()"
                                      Width="180px" Height="180px" />
                        }
                        else
                        {
                            <MudAlert Severity="Severity.Info" Variant="Variant.Outlined" Class="mt-10">No delays for this selection.</MudAlert>
                        }
                    </MudCardContent>
                </MudCard>
            </MudStack>
        </MudItem>

        <MudItem xs="12" md="8">
            <MudCard Elevation="2" Style="height: 415px;">
                <MudTable Items="@Engine.MixerEfficiencyRanking" Hover="true" Dense="true" FixedHeader="true" Height="340px" Elevation="0">
                    <ToolBarContent><MudText Typo="Typo.h6">Mixer Performance Comparison</MudText></ToolBarContent>
                    <HeaderContent>
                        <MudTh>Asset</MudTh>
                        <MudTh>Starved Time</MudTh>
                        <MudTh>Efficiency</MudTh>
                    </HeaderContent>
                    <RowTemplate>
                        <MudTd Style="@(context.Name == _selectedMixer ? "background-color: var(--mud-palette-info-lighten-2); font-weight: bold;" : "")">
                            @context.Name
                        </MudTd>
                        <MudTd>@context.StarvedMinutes.ToString("F2") min</MudTd>
                        <MudTd>
                            <div class="d-flex align-center">
                                <MudProgressLinear Color="@GetColor(context.Availability)" Value="@context.Availability" Class="flex-grow-1 mr-3" Style="height:10px; border-radius:5px;" />
                                <MudText Typo="Typo.caption" Style="font-weight: 700;">@context.Availability.ToString("F0")%</MudText>
                            </div>
                        </MudTd>
                    </RowTemplate>
                </MudTable>
            </MudCard>
        </MudItem>

        <MudItem xs="12">
            <MudCard Elevation="2" Class="mud-border-warning border-l-4 border-solid">
                <MudTable Items="@GetFilteredFriction()" Hover="true" Dense="true" Striped="true" Elevation="0">
                    <ToolBarContent>
                        <MudIcon Icon="@Icons.Material.Filled.LinkOff" Color="Color.Warning" Class="mr-2" />
                        <MudText Typo="Typo.h6">Resource Friction Matrix @(_selectedMixer == "All" ? "(Global)" : $"- {_selectedMixer}")</MudText>
                    </ToolBarContent>
                    <HeaderContent>
                        <MudTh>Mixer Affected</MudTh>
                        <MudTh>Shared Resource</MudTh>
                        <MudTh Style="text-align:center;">Stops</MudTh>
                        <MudTh>Total Time Lost</MudTh>
                    </HeaderContent>
                    <RowTemplate>
                        <MudTd><b>@context.MixerName</b></MudTd>
                        <MudTd><MudChip T="string" Size="Size.Small" Variant="Variant.Text">@context.ResourceName</MudChip></MudTd>
                        <MudTd Style="text-align:center;">
                            <MudText Typo="Typo.body2">@context.StopCount</MudText>
                        </MudTd>
                        <MudTd>
                            <MudText Color="Color.Error" Style="font-weight: 800;">@context.LostMinutes.ToString("F2") min</MudText>
                        </MudTd>
                    </RowTemplate>
                </MudTable>
            </MudCard>
        </MudItem>
    </MudGrid>
</MudContainer>

<style>
    .border-l-4 {
        border-left-width: 6px !important;
    }
</style>

@code {
    [Parameter] public NewSimulationEngine Engine { get; set; }
    private string _selectedMixer = "All";

    private void OnMixerChanged(string value)
    {
        _selectedMixer = value;
        StateHasChanged();
    }

    // LÓGICA DE FILTRADO

    private string GetCriticalPump()
    {
        var data = _selectedMixer == "All"
            ? Engine.PumpBottleneckRanking
            : Engine.PumpBottleneckRanking.Where(p => Engine.FrictionMatrix.Any(f => f.MixerName == _selectedMixer && f.ResourceName == p.Name)).ToList();

        return data.FirstOrDefault()?.Name ?? "Normal";
    }

    private Dictionary<string, double> GetFilteredReasons()
    {
        // 1. Si es "All", usamos la propiedad del Engine que ya debería ser "Live"
        if (_selectedMixer == "All")
        {
            return Engine.DowntimeReasons.ToDictionary(r => r.Reason, r => r.TotalMinutes);
        }

        // 2. Si es un mixer específico, combinamos su historial con su paso activo
        var mixer = Engine.Mixers.FirstOrDefault(m => m.Name == _selectedMixer);
        if (mixer == null) return new Dictionary<string, double>();

        // Creamos una lista temporal que une pasado y presente
        var currentAndPastSteps = mixer.BatchManager.ExecutionHistory.ToList();
        if (mixer.BatchManager.CurrentStep != null)
        {
            currentAndPastSteps.Add(mixer.BatchManager.CurrentStep);
        }

        return currentAndPastSteps
            .GroupBy(s => s.GetType().Name.Replace("Step", ""))
            .ToDictionary(
                g => g.Key,
                g => g.Sum(s => (double)s.AccumulatedStarvation) / 60.0 // Forzamos double para precisión
            );
    }

    private IEnumerable<FrictionReport> GetFilteredFriction()
    {
        return _selectedMixer == "All"
            ? Engine.FrictionMatrix
            : Engine.FrictionMatrix.Where(f => f.MixerName == _selectedMixer);
    }

    private Color GetColor(double val) => val switch
    {
        >= 95 => Color.Success,
        >= 80 => Color.Info,
        >= 60 => Color.Warning,
        _ => Color.Error
    };
}